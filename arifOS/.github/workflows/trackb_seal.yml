name: Track B SEAL - Spec Integrity

on:
  push:
    branches: [ main, master ]
    paths:
      - 'spec/v45/**'
      - 'arifos_core/enforcement/metrics.py'
      - 'arifos_core/enforcement/genius_metrics.py'
      - 'arifos_core/governance/session_physics.py'
      - 'arifos_core/spec/**'
      - 'tests/test_spec_v45_*.py'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'spec/v45/**'
      - 'arifos_core/enforcement/metrics.py'
      - 'arifos_core/enforcement/genius_metrics.py'
      - 'arifos_core/governance/session_physics.py'
      - 'arifos_core/spec/**'
      - 'tests/test_spec_v45_*.py'

jobs:
  verify-manifest-integrity:
    name: Verify SHA-256 Manifest
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .

      - name: Verify manifest hashes (CI check)
        run: |
          python scripts/regenerate_manifest_v45.py --check

  run-schema-enforcement-tests:
    name: Schema Validation Tests
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .[dev]

      - name: Run schema enforcement tests (subprocess proof)
        run: |
          pytest tests/test_spec_v45_schema_enforcement_subprocess.py -v --tb=short

  run-manifest-enforcement-tests:
    name: Manifest Verification Tests
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .[dev]

      - name: Run manifest enforcement tests (subprocess proof)
        run: |
          pytest tests/test_spec_v45_manifest_enforcement_subprocess.py -v --tb=short

  run-full-test-suite:
    name: Full Test Suite (Green Gate)
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .[dev]

      - name: Run full test suite (pytest -q)
        run: |
          pytest -q

  seal-verdict:
    name: SEAL Verdict
    runs-on: ubuntu-latest
    needs: [verify-manifest-integrity, run-schema-enforcement-tests, run-manifest-enforcement-tests, run-full-test-suite]

    permissions:
      contents: read

    steps:
      - name: SEAL confirmed
        run: |
          echo "========================================="
          echo "Track B v45 SEAL: VERIFIED"
          echo "========================================="
          echo "Manifest integrity: PASS"
          echo "Schema enforcement: PASS"
          echo "Manifest enforcement: PASS"
          echo "Full test suite: PASS"
          echo "========================================="
          echo "DITEMPA BUKAN DIBERI - Spec sealed."
